name: Deploy to VPS

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Sanity check
        run: |
          set -e
          pwd
          ls -la
          test -d backend || (echo "backend/ not found" && exit 1)
          test -f compose.yml || (echo "compose.yml not found" && exit 1)
          test -f compose.dev.yml || echo "compose.dev.yml: not present (ok)"
          test -d docs || echo "docs/: not present (ok)"

      # ðŸš§ Ð¡Ð´ÐµÐ»Ð°Ñ‚ÑŒ /opt/kitchen Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹Ð¼ Ñ‚Ð²Ð¾ÐµÐ¼Ñƒ SSH-Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŽ
      - name: Prepare target dir on VPS (fix owner/perm)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          fingerprint: ${{ secrets.SSH_FINGERPRINT }}
          # port: ${{ secrets.SSH_PORT }}
          script: |
            set -e
            ME="$(whoami)"
            echo "Logged in as: $ME"
            sudo mkdir -p /opt/kitchen
            # Ð¾Ñ‚Ð´Ð°Ñ‚ÑŒ ÐºÐ°Ñ‚Ð°Ð»Ð¾Ð³ Ñ‚Ð²Ð¾ÐµÐ¼Ñƒ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŽ, Ñ‡Ñ‚Ð¾Ð±Ñ‹ scp-action Ð¼Ð¾Ð³ Ñ€Ð°ÑÐ¿Ð°ÐºÐ¾Ð²Ð°Ñ‚ÑŒ Ð°Ñ€Ñ…Ð¸Ð²
            sudo chown -R "$ME":"$ME" /opt/kitchen

      # â¬†ï¸ Ñ‚ÐµÐ¿ÐµÑ€ÑŒ Ñ€Ð°ÑÐ¿Ð°ÐºÐ¾Ð²ÐºÐ° Ð¿Ñ€Ð¾Ð¹Ð´Ñ‘Ñ‚ Ð±ÐµÐ· Permission denied
      - name: Upload project to /opt/kitchen via SCP
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          fingerprint: ${{ secrets.SSH_FINGERPRINT }}
          # Ð’ÐÐ–ÐÐž: Ð¾Ð´Ð½Ð° ÑÑ‚Ñ€Ð¾ÐºÐ°, Ñ‡ÐµÑ€ÐµÐ· Ð·Ð°Ð¿ÑÑ‚ÑƒÑŽ, Ñ Ð¿Ñ€ÐµÑ„Ð¸ÐºÑÐ¾Ð¼ ./ (Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð½Ðµ ÑÐ»Ð¾Ð²Ð¸Ñ‚ÑŒ "empty archive")
          source: "./backend/**,./docs/**,./compose.yml,./compose.dev.yml,./.gitignore"
          target: "/opt/kitchen"
          overwrite: true
          rm: false
          strip_components: 0
          debug: true
          # port: ${{ secrets.SSH_PORT }}

      - name: Deploy on VPS (compose up + migrations + healthcheck)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          fingerprint: ${{ secrets.SSH_FINGERPRINT }}
          # port: ${{ secrets.SSH_PORT }}
          script: |
            set -euo pipefail
            cd /opt/kitchen

            # ÐÐ° Ð²ÑÑÐºÐ¸Ð¹ ÑÐ»ÑƒÑ‡Ð°Ð¹ â€” ÐµÑÐ»Ð¸ Ñ‡Ñ‚Ð¾-Ñ‚Ð¾ Ð¾Ð¿ÑÑ‚ÑŒ ÑÑ‚Ð°Ð»Ð¾ Ñ€ÑƒÑ‚Ð°, Ð²ÐµÑ€Ð½ÑƒÑ‚ÑŒ ÑÐµÐ±Ðµ
            if command -v sudo >/dev/null 2>&1; then
              sudo chown -R "$USER":"$USER" /opt/kitchen || true
            fi

            echo "â†’ docker compose pull (best effort)"
            docker compose pull || true

            echo "â†’ docker compose up -d --build"
            docker compose up -d --build

            echo "â†’ Wait for PostgreSQL"
            until docker compose exec -T db bash -lc 'pg_isready -U "$POSTGRES_USER" -d "$POSTGRES_DB" -h localhost'; do
              sleep 1
            done

            echo "â†’ Alembic migrations"
            docker compose exec -T api alembic upgrade head || docker compose run --rm api alembic upgrade head

            echo "â†’ Healthcheck API"
            curl -fsS http://127.0.0.1:8000/docs >/dev/null

            echo "âœ… Deploy OK"
