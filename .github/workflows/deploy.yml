name: Deploy to VPS

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Show workspace tree
        run: |
          pwd
          ls -la
          git rev-parse --short HEAD

      - name: Deploy via SSH (git pull on server)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT }}
          fingerprint: ${{ secrets.SSH_FINGERPRINT }}
          script: |
            set -euo pipefail
            cd /opt/kitchen
            if [ -d .git ]; then
              git fetch --all
              git reset --hard origin/main
            else
              git clone --depth=1 --branch main ${{ secrets.GIT_REPO_SSH }} /opt/kitchen
            fi
            docker compose up -d --build
            until docker compose exec -T db bash -lc 'pg_isready -U "$POSTGRES_USER" -d "$POSTGRES_DB" -h localhost'; do sleep 1; done
            docker compose exec -T api alembic upgrade head || docker compose run --rm api alembic upgrade head
            curl -fsS http://127.0.0.1:8000/docs >/dev/null && echo "API OK"
